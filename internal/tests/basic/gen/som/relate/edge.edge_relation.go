// Code generated by github.com/go-surreal/som, DO NOT EDIT.
package relate

import (
	"context"
	"errors"
	"fmt"
	som "github.com/go-surreal/som/tests/basic/gen/som"
	conv "github.com/go-surreal/som/tests/basic/gen/som/conv"
	internal "github.com/go-surreal/som/tests/basic/gen/som/internal"
	model "github.com/go-surreal/som/tests/basic/model"
	models "github.com/surrealdb/surrealdb.go/pkg/models"
)

type edgeRelation struct {
	db Database
}

// Create creates a new edge between the given nodes.
// Note: The ID type if both nodes must be a string or number for now.

func (e edgeRelation) Create(ctx context.Context, edge *model.EdgeRelation) error {
	if edge == nil {
		return errors.New("the given edge must not be nil")
	}
	if edge.ID() != "" {
		return errors.New("ID must not be set for an edge to be created")
	}
	if edge.AllTypes.ID() == "" {
		return errors.New("ID of the incoming node 'AllTypes' must not be empty")
	}
	if edge.SpecialTypes.ID() == "" {
		return errors.New("ID of the outgoing node 'SpecialTypes' must not be empty")
	}
	inID := models.NewRecordID("all_types", edge.AllTypes.ID())
	outID := models.NewRecordID("special_types", som.UUID(edge.SpecialTypes.ID()))
	query := "RELATE $inID->edge_relation->$outID CONTENT $data"
	data := conv.FromEdgeRelation(*edge)
	res, err := e.db.Query(ctx, query, map[string]any{"inID": inID, "outID": outID, "data": data})
	if err != nil {
		return fmt.Errorf("could not create relation: %w", err)
	}
	var rawResult []internal.QueryResult[conv.EdgeRelation]
	err = e.db.Unmarshal(res, &rawResult)
	if err != nil {
		return fmt.Errorf("could not unmarshal relation: %w", err)
	}
	if len(rawResult) < 1 || len(rawResult[0].Result) < 1 {
		return errors.New("no result returned for relation")
	}
	convEdge := &rawResult[0].Result[0]
	*edge = conv.ToEdgeRelation(convEdge)
	return nil
}

func (edgeRelation) Update(edge *model.EdgeRelation) error {
	// TODO: implement!
	return errors.New("not yet implemented")
}

func (edgeRelation) Delete(edge *model.EdgeRelation) error {
	// TODO: implement!
	// https://surrealdb.com/docs/surrealdb/surrealql/statements/delete#deleting-graph-edges
	return errors.New("not yet implemented")
}
