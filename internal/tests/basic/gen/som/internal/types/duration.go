// Code generated by github.com/go-surreal/som, DO NOT EDIT.

package types

import (
	"fmt"
	"time"

	cbor "github.com/go-surreal/som/tests/basic/gen/som/internal/cbor"
)

const (
	tagDuration = 14
	nanosecond  = 1e9
)

// Duration wraps time.Duration and provides CBOR marshaling for SurrealDB.
type Duration struct {
	time.Duration
}

func (d *Duration) MarshalCBOR() ([]byte, error) {
	if d == nil {
		data, err := cbor.Marshal(nil)
		if err != nil {
			return nil, fmt.Errorf("failed to marshal nil: %w", err)
		}

		return data, nil
	}

	totalSeconds := int64(d.Seconds())
	totalNanoseconds := d.Nanoseconds()
	remainingNanoseconds := totalNanoseconds - (totalSeconds * nanosecond)

	content, err := cbor.Marshal([]int64{totalSeconds, remainingNanoseconds})
	if err != nil {
		return nil, fmt.Errorf("failed to marshal duration slice: %w", err)
	}

	data, err := cbor.Marshal(cbor.RawTag{
		Number:  tagDuration,
		Content: content,
	})
	if err != nil {
		return nil, fmt.Errorf("failed to marshal raw tag: %w", err)
	}

	return data, nil
}

func (d *Duration) UnmarshalCBOR(data []byte) error {
	var val []int64

	if err := cbor.Unmarshal(data, &val); err != nil {
		return fmt.Errorf("failed to unmarshal duration: %w", err)
	}

	if len(val) > expectedArrayLength {
		return fmt.Errorf("invalid duration array length: expected at most %d elements, got %d", expectedArrayLength, len(val))
	}

	var dur time.Duration

	if len(val) > 0 {
		dur = time.Duration(val[0]) * time.Second
	}

	if len(val) > 1 {
		dur += time.Duration(val[1])
	}

	d.Duration = dur

	return nil
}
