// Code generated by github.com/go-surreal/som, DO NOT EDIT.

package types

import (
	"fmt"
	"time"

	cbor "github.com/go-surreal/som/tests/basic/gen/som/internal/cbor"
)

const (
	tagDatetime         = 12
	expectedArrayLength = 2
)

// DateTime wraps time.Time and provides CBOR marshaling for SurrealDB.
type DateTime struct {
	time.Time
}

func (dt *DateTime) MarshalCBOR() ([]byte, error) {
	if dt == nil {
		return cbor.None, nil
	}

	data, err := cbor.Marshal(cbor.Tag{
		Number:  tagDatetime,
		Content: []int64{dt.Unix(), int64(dt.Nanosecond())},
	})
	if err != nil {
		return nil, fmt.Errorf("failed to marshal datetime: %w", err)
	}

	return data, nil
}

func (dt *DateTime) UnmarshalCBOR(data []byte) error {
	if cbor.IsNoneOrNull(data) {
		dt.Time = time.Time{}
		return nil
	}

	var val []int64

	if err := cbor.Unmarshal(data, &val); err != nil {
		return fmt.Errorf("failed to unmarshal datetime: %w", err)
	}

	if len(val) == 0 {
		dt.Time = time.Time{}
		return nil
	}

	if len(val) > expectedArrayLength {
		return fmt.Errorf("invalid datetime array length: expected 0-2 elements, got %d", len(val))
	}

	secs := val[0]
	nano := int64(0)

	if len(val) > 1 {
		nano = val[1]
	}

	dt.Time = time.Unix(secs, nano).UTC()

	return nil
}
