{{- /* gotype: github.com/go-surreal/som/core/embed.Template */ -}}
//go:build embed

package types

import (
	"fmt"
	"time"

	cbor "{{.GenerateOutPath}}/internal/cbor"
)

const (
	tagDuration = 14
	nanosecond  = 1e9
)

// Duration wraps time.Duration and provides CBOR marshaling for SurrealDB.
type Duration struct {
	time.Duration
}

func (d *Duration) MarshalCBOR() ([]byte, error) {
	if d == nil {
		return cbor.None(), nil
	}

	totalNanoseconds := d.Nanoseconds()
	totalSeconds := totalNanoseconds / int64(nanosecond)
	remainingNanoseconds := totalNanoseconds % int64(nanosecond)

	data, err := cbor.Marshal(cbor.Tag{
		Number:  tagDuration,
		Content: []int64{totalSeconds, remainingNanoseconds},
	})
	if err != nil {
		return nil, fmt.Errorf("failed to marshal duration: %w", err)
	}

	return data, nil
}

func (d *Duration) UnmarshalCBOR(data []byte) error {
	if cbor.IsNoneOrNull(data) {
		d.Duration = 0
		return nil
	}

	var val []int64

	if err := cbor.Unmarshal(data, &val); err != nil {
		return fmt.Errorf("failed to unmarshal duration: %w", err)
	}

	if len(val) > expectedArrayLength {
		return fmt.Errorf("invalid duration array length: expected at most %d elements, got %d", expectedArrayLength, len(val))
	}

	var dur time.Duration

	if len(val) > 0 {
		dur = time.Duration(val[0]) * time.Second
	}

	if len(val) > 1 {
		dur += time.Duration(val[1])
	}

	d.Duration = dur

	return nil
}
